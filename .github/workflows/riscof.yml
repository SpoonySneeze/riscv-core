name: RISC-V Compliance

on: [push, pull_request]

jobs:
  compliance-check:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout your code
    - uses: actions/checkout@v3

    # 2. Install Tools (Icarus & GCC)
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y iverilog gcc-riscv64-unknown-elf python3-pip

    # 3. Install RISCOFF and SAIL (Reference Model)
    - name: Install RISCOFF & Sail
      run: |
        pip3 install riscof
        # We need the sail emulator for the reference model
        # (This is a simplified setup using pre-built binaries if available, 
        #  or we fallback to SPIKE if SAIL is too heavy. For now, let's use standard riscof setup)
        riscof --help

    # 4. Clone Architecture Tests
    - name: Clone Tests
      run: git clone https://github.com/riscv-non-isa/riscv-arch-test.git

    # 5. Run Compliance
    - name: Run RISCOFF
      run: |
        cd compliance
        
        # --- SAFE SETUP START ---
        # 1. Make a temporary folder so 'riscof setup' doesn't overwrite YOUR files
        mkdir temp_setup
        cd temp_setup
        
        # 2. Generate the Reference Plugin (Sail) here
        # We use 'dummy' for the DUT name because we don't care about it here, we only want sail_cSim
        riscof setup --dutname=dummy --refname=sail_cSim
        cd ..
        
        # 3. Move ONLY the 'sail_cSim' folder to your main directory
        mv temp_setup/sail_cSim .
        
        # 4. Clean up
        rm -rf temp_setup
        # --- SAFE SETUP END ---

        # 5. Run the tests using YOUR existing config.ini
        # We added --no-browser so it doesn't try to open a web page in the cloud
        riscof run --config=config.ini --suite=../riscv-arch-test/riscv-test-suite/ --env=../riscv-arch-test/riscv-test-suite/env --no-browser

    # 6. Upload Report
    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance/riscof_work/report.html
