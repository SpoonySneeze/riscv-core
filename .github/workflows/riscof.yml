name: RISC-V Compliance

on: [push, pull_request]

jobs:
  compliance-check:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout your code
    - uses: actions/checkout@v3

    # 2. Install Tools (Icarus & GCC)
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y iverilog gcc-riscv64-unknown-elf python3-pip

    # 3. Install RISCOFF and SAIL (Reference Model)
    - name: Install RISCOFF & Sail
      run: |
        pip3 install riscof
        # We need the sail emulator for the reference model
        # (This is a simplified setup using pre-built binaries if available, 
        #  or we fallback to SPIKE if SAIL is too heavy. For now, let's use standard riscof setup)
        riscof --help

    # 4. Clone Architecture Tests
    - name: Clone Tests
      run: git clone https://github.com/riscv-non-isa/riscv-arch-test.git

    # 5. Run Compliance
    - name: Run RISCOFF
      run: |
        cd compliance
        
        # --- 1. SETUP REFERENCE PLUGIN ---
        mkdir temp_setup
        cd temp_setup
        riscof setup --dutname=dummy --refname=sail_cSim
        cd ..
        mv temp_setup/sail_cSim .
        rm -rf temp_setup

        # --- 2. GENERATE ROBUST CONFIG.INI (Absolute Paths) ---
        # We generate the file on the fly using $(pwd) to guarantee paths are correct.
        echo "[RISCOF]" > config.ini
        echo "ReferencePlugin = sail_cSim" >> config.ini
        echo "ReferencePluginPath = $(pwd)/sail_cSim" >> config.ini   # Points to FOLDER
        echo "DUTPlugin = mycore" >> config.ini
        echo "DUTPluginPath = $(pwd)/mycore" >> config.ini             # Points to FOLDER
        echo "verbose = False" >> config.ini
        echo "" >> config.ini
        
        echo "[sail_cSim]" >> config.ini
        echo "pluginpath = $(pwd)/sail_cSim" >> config.ini
        echo "" >> config.ini
        
        echo "[mycore]" >> config.ini
        echo "pluginpath = $(pwd)/mycore" >> config.ini
        # --- FIX: Use correct keys matching your updated python script ---
        echo "isa_spec = $(pwd)/mycore/riscv_isa.yaml" >> config.ini
        echo "platform_spec = $(pwd)/mycore/riscv_platform.yaml" >> config.ini
        echo "target_run = 1" >> config.ini
        echo "riscv_prefix = riscv64-unknown-elf-" >> config.ini

        # --- 3. RUN TESTS ---
        # Add current directory to PYTHONPATH so python finds the modules
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        
        riscof run --config=config.ini --suite=../riscv-arch-test/riscv-test-suite/ --env=../riscv-arch-test/riscv-test-suite/env --no-browser
        
    # 6. Upload Report
    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance/riscof_work/report.html
